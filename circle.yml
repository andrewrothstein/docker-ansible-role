---
---
# Assumed vars and example from CircleCI
# CIRCLE_PROJECT_REPONAME: docker-ansible-role
# CIRCLE_PROJECT_USERNAME: andrewrothstein

# Registry credentials:
# DOCKER_USER: andrewrothstein+robot-234
# DOCKER_PASSWORD: d88be5ba-f405-11e6-8852-234995e46dba
# DOCKER_EMAIL: andrew.rothstein@gmail.com
# DOCKER_REGISTRY: quay.io

# Container building...
# DOCKER_UPSTREAM_USERNAME: andrewrothstein
# DOCKER_UPSTREAM_REPONAME: docker-ansible
# needs read access to ${DOCKER_REGISTRY}/${DOCKER_UPSTREAM_USERNAME}/${DOCKER_UPSTREAM_REPONAME}:${OS}
# builds tagged containers named ${DOCKER_REGISTRY}/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}:${OS}

machine:
  services:
    - docker

dependencies:
  pre:
    - sudo -H pip install --upgrade pip
    - sudo -H pip install circleci-helpers

test:
  override:
    - ? | 
          circle-matrix <<"EHD"
            env:
              - OS=alpine_3.3
              - OS=alpine_3.4
              - OS=alpine_3.5
              - OS=alpine_edge
              - OS=centos_7
              - OS=debian_jessie
              - OS=fedora_23
              - OS=fedora_24
              - OS=fedora_25
              - OS=ubuntu_trusty
              - OS=ubuntu_xenial

            script:
              - >-
                ./dcb.py
                --upstreamregistry ${DOCKER_REGISTRY}
                --upstreamemail ${DOCKER_EMAIL}
                --upstreamgroup andrewrothstein
                --upstreamapp docker-ansible
                --pull ${OS}
                --build ${OS}
              - >-
                ./dcb.py
                --targetregistry ${DOCKER_REGISTRY}
                --targetuser ${DOCKER_USER}
                --targetpwd ${DOCKER_PASSWORD}
                --targetemail ${DOCKER_EMAIL}
                --targetgroup ${CIRCLE_PROJECT_USERNAME}
                --targetapp ${CIRCLE_PROJECT_REPONAME}
                --push ${OS}

          EHD
      :
        parallel: true
